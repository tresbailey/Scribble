<!DOCTYPE html>
<!-- saved from url=(0066)http://twitter.github.com/bootstrap/examples/starter-template.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Bootstrap, from Twitter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
    <link href="http://twitter.github.com/bootstrap/assets/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="http://twitter.github.com/bootstrap/assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://twitter.github.com/bootstrap/assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://twitter.github.com/bootstrap/assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="http://twitter.github.com/bootstrap/assets/ico/apple-touch-icon-57-precomposed.png">
  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="http://twitter.github.com/bootstrap/examples/starter-template.html#">Project name</a>
          <div class="nav-collapse">
            <ul class="nav">
              <li class="active"><a href="http://twitter.github.com/bootstrap/examples/starter-template.html#">Home</a></li>
              <li><a href="http://twitter.github.com/bootstrap/examples/starter-template.html#about">About</a></li>
              <li><a href="http://twitter.github.com/bootstrap/examples/starter-template.html#contact">Contact</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

<div class="modal" id="myModal">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">Ã—</a>
    <h3>Modal header</h3>
  </div>
  <div class="modal-body">
    <textarea id="pin_desc" rows="5" columns="20" ></textarea>
  </div>
  <div class="modal-footer">
    <a href="#" id="pin_close" class="btn">Close</a>
    <a href="#" id="pin_save" class="btn btn-primary">Save changes</a>
  </div>
</div>
    <div class="container">

      <h1>Bootstrap starter template</h1>
      <div>
        Lets hope this gets shown from behind the canvas
      </div>
      <div class="row">
        <div class="span10">
      <canvas id="myCanvas" style=""> 

      </canvas>  
        </div>
      </div>
      <div class="row" style="">
        <div class="span3 ">
          <input id="freehand" type="button" class="btn" value="Freehand">
          <input id="marker" type="button" class="btn" value="Marker">
          <input id="save" type="button" class="btn" value="Save">
        </div>
      </div>
    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

    <script src="./starter-template_files/jquery.js"></script>
    <script>
    sketch = false;
    sketchPos = {
      x: null,
      y: null
    };
    marks = [];
    image_data = [];
    freehand = true;
    $(document).ready(function() {
      $('#myCanvas').mousedown(function(e) {
        if (freehand) {
          var mouseX = e.pageX;
          var mouseY = e.pageY;
          sketch = true;
          sketchPos.x = e.pageX;
          sketchPos.y = e.pageY;
          drawPixels(mouseX, mouseY);	
        }
      });
      $('#myCanvas').mousemove(function(e) {
        if(sketch) {
          var mouseX = e.pageX - this.offsetLeft;
          var mouseY = e.pageY - this.offsetTop;
          drawPixels(mouseX, mouseY);
      }});
      $('#myCanvas').mouseup(function(e) {
        if(freehand) {
          sketch = false;
        }
      });
      $('#myCanvas').click(function(e) {
        if(!freehand) {
          var mouseX = e.pageX - this.offsetLeft;
          var mouseY = e.pageY - this.offsetTop;
          drawCircle(mouseX, mouseY);
          $('#myModal').modal('show');
          $('#pin_close').click(function(e) {
            $('#pin_desc').val('');
            $('#myModal').modal('hide');
          });
          $('#pin_save').click(function(e) {
            descr = $('#pin_desc').val();
            alert([mouseX, mouseY]);
            marks.push([[mouseX, mouseY], descr]);
            $('#myModal').modal('hide');
            //$('#pin_desc').val('');
          });
        }
      });
      $('#freehand').click(function(e) {
        freehand = true;
      });
      $('#marker').click(function(e) {
        freehand = false;
      });
$('#myModal').modal({
  keyboard: false
});
$('#myModal').modal('hide');
      $("#save").click(function(e) {
        scrape_pixels();

		input = {canvas_data: image_data,
                marks_data: marks,
                base_html: $('body').html()
              }
        $.ajax({ 
		url: 'http://localhost:5000/4f9ca5c0319d7d167c000000',
		data: JSON.stringify(input),
       type: 'POST',
       contentType: 'application/json;charset=UTF-8',
       dataType: 'application/json'
       });
      });
    });

    function scrape_pixels() {
      var cheight = $('#myCanvas').height();
      var cwidth = $('#myCanvas').width();
      var canvas = document.getElementById('myCanvas');
      var context = canvas.getContext('2d');
      for(x=0; x < cwidth; x++) {
        for(y=0; y < cheight; y++) {
          var pixel = context.getImageData(x, y, 1, 1);
          if (pixel.data[0]!=0 || pixel.data[1]!=0 || pixel.data[2]!=0 || pixel.data[3]!=0) {
            image_data.push([[x, y], pixel.data[0], pixel.data[1], pixel.data[2], pixel.data[3]]);
          }
        }
      }
    }
    
    function drawPixels(xPos, yPos) {
      var canvas = document.getElementById('myCanvas');
      var context = canvas.getContext('2d');
      context.beginPath();
      context.moveTo(sketchPos.x, sketchPos.y);
      context.lineTo(xPos, yPos);
      context.lineWidth = 5;
      context.lineCap = "round";
      context.stroke();
      sketchPos.x = xPos;
      sketchPos.y = yPos;
    }
    function drawCircle(xPos, yPos) {
      //http://falcon80.com/HTMLCanvas/BasicShapes/Circle.html
      var canvas = document.getElementById('myCanvas');
      var context = canvas.getContext('2d');
      context.moveTo(xPos, yPos);
      context.strokeStyle = 'red';
      var radius = 5;
      var start = 0 * Math.PI / 180;
      var end = 360 * Math.PI /180;
      context.arc(xPos, yPos, radius, start, end, false);
      context.fill();
    }



    </script>
    <script src="./starter-template_files/bootstrap-transition.js"></script>
    <script src="./starter-template_files/bootstrap-alert.js"></script>
    <script src="./starter-template_files/bootstrap-modal.js"></script>
    <script src="./starter-template_files/bootstrap-dropdown.js"></script>
    <script src="./starter-template_files/bootstrap-scrollspy.js"></script>
    <script src="./starter-template_files/bootstrap-tab.js"></script>
    <script src="./starter-template_files/bootstrap-tooltip.js"></script>
    <script src="./starter-template_files/bootstrap-popover.js"></script>
    <script src="./starter-template_files/bootstrap-button.js"></script>
    <script src="./starter-template_files/bootstrap-collapse.js"></script>
    <script src="./starter-template_files/bootstrap-carousel.js"></script>
    <script src="./starter-template_files/bootstrap-typeahead.js"></script>

  

</body></html>
